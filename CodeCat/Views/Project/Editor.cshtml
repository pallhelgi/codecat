@model CodeCat.Models.ViewModels.DocumentViewModel

<!--The Ace Editor begin-->
<div class="container">
    <div id="ace-editor">
        @ViewBag.Code
        <!--    //This is your javascript code

            function foo(items) {
                var x = "I am Code::Cat";
                return x;
            }
        -->
    </div>
</div>

<!-- Save button for Document -->
@using (Html.BeginForm("save", "Document", FormMethod.Post))
{
    <div class="container editor-save-div">
        @Html.HiddenFor(m => m.document.content, new { @id = "hidden-editor" })
        <input type="submit" value="Save" class="editor-save-button btn btn-success" />

        <button type="button" onclick="k()">Button...</button>
        <script>
            var url = window.location.href;
            var projectID = parseInt(url.substring(url.lastIndexOf('/') + 1));
            console.log(projectID);

            function k() {
                window.location.href = "../../Document/AddDocument/" + projectID;
            };
        </script>
    </div>
}

@section scripts
{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="~/Scripts/jquery.signalR-2.2.2.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>

        var documentID = @ViewBag.DocumentID;

        var editor = ace.edit("ace-editor");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/javascript");

        /*Should save the form on submit button click*/
        $("form").submit(function () {
            console.log("Hallo");
            console.log($("#hidden-editor").val(editor.getSession().getValue()));
            $("#hidden-editor").val(editor.getSession().getValue());
        });
        var codeHub = $.connection.codeHub;
        var silent = false;

        codeHub.client.onChange = function (changeData) {
            console.log(changeData);

            silent = true;
            editor.getSession().getDocument().applyDelta(changeData);
            silent = false;
        };

        $.connection.hub.start().done(function () {

            codeHub.server.joinDocument(documentID);

            editor.on("change", function (obj) {
                if (silent){
                    return;
                }
                console.log(obj);
                codeHub.server.onChange(obj, documentID);
            });
        });
    </script>
}


